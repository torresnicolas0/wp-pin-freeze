(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.compose,n=window.wp.data,i=window.wp.element,r=window.wp.hooks,s=window.wp.i18n,a=window.wp.plugins,o=window.wp.apiFetch;var l=e.n(o);const p=window.wp.blocks,c=window.wp.blockEditor,d=window.wp.components,f=window.wp.url,u=window.ReactJSXRuntime,{Button:_,Notice:m,PanelBody:w,TextareaControl:h,ToggleControl:b}=d,y=d.__experimentalCodeEditor||d.CodeEditor,g=/^\s*<!--\s*wp:[\s\S]*-->\s*$/;function v(e){return!e||"string"!=typeof e||g.test(e)}function z(e){return"string"!=typeof e?"":e.trim()}function x(e){return Array.isArray(e)?e.filter(e=>e&&"object"==typeof e&&"string"==typeof e.html).map(e=>({html:z(e.html),capturedAt:"string"==typeof e.capturedAt?e.capturedAt:""})).filter(e=>""!==e.html&&!v(e.html)).slice(0,5):[]}function j(e,t){const n=z(e),i=x(t);if(""===n||v(n))return i;const r=i.filter(e=>e.html!==n);return[(s=n,{html:s,capturedAt:(new Date).toISOString()}),...r].slice(0,5);var s}function N(e){if(!e||"string"!=typeof e)return(0,s.__)("Sin fecha","pin-freeze");const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}function k(e){const t=z(e).replace(/\s+/g," ");return t?t.length<=96?t:`${t.slice(0,93)}...`:""}const C=function({attributes:e,clientId:t,isSelected:r,setAttributes:a}){const{wppf_html:o="",wppf_is_pinned:d=!1,wppf_history:g=[]}=e||{},[C,S]=(0,i.useState)(!1),[P,E]=(0,i.useState)(""),[T,L]=(0,i.useState)(o||""),[H,B]=(0,i.useState)(""),{block:D,postId:q}=(0,n.useSelect)(e=>({block:e("core/block-editor").getBlock(t),postId:e("core/editor").getCurrentPostId()}),[t]);if((0,i.useEffect)(()=>{L(o||"")},[o]),!r)return null;const M=x(g),R=e=>{E(""),B(""),L(e||"")};let A=(0,s.__)("Congela la salida del bloque para reemplazar su render dinámico.","pin-freeze");d&&(A=(0,s.__)("Este bloque está pineado y usa HTML estático.","pin-freeze")),C&&(A=(0,s.__)("Capturando HTML renderizado del bloque…","pin-freeze"));const I=T!==(o||"");return(0,u.jsx)(c.InspectorControls,{children:(0,u.jsxs)(w,{title:(0,s.__)("Pin & Freeze","pin-freeze"),initialOpen:!0,children:[(0,u.jsx)(b,{label:(0,s.__)("Pin HTML","pin-freeze"),help:A,checked:d,onChange:async e=>{if(!e)return E(""),B(""),void a({wppf_is_pinned:!1});if(o&&!v(o))return E(""),B(""),void a({wppf_is_pinned:!0});S(!0),E("");try{const e=await(async()=>{if(!D)return"";const e=(0,p.getBlockType)(D.name),t=z((0,p.getBlockContent)(D));if(!e||"function"!=typeof e.save||v(t))try{const e={context:"edit"};q&&(e.post_id=Number(q));const t=(0,f.addQueryArgs)(`/wp/v2/block-renderer/${encodeURIComponent(D.name)}`,e),n=await l()({path:t,method:"POST",data:{attributes:D.attributes||{}}}),i=z(n?.rendered||"");if(i&&!v(i))return i}catch{}return t&&!v(t)?t:""})();if(e)return a({wppf_is_pinned:!0,wppf_html:e,wppf_history:j(o,M)}),void B((0,s.__)("HTML capturado y aplicado. Revisa el bloque pineado en el lienzo antes de guardar.","pin-freeze"));a({wppf_is_pinned:!1}),E((0,s.__)("No se pudo capturar HTML renderizado para este bloque. Intenta refrescar o guardar y reintentar.","pin-freeze"))}finally{S(!1)}},disabled:C}),!!P&&(0,u.jsx)(m,{status:"warning",isDismissible:!1,className:"wppf-block-capture-notice",children:(0,u.jsx)("p",{children:P})}),d&&(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)("p",{className:"wppf-inspector-help",children:(0,s.__)("HTML estático del bloque pineado:","pin-freeze")}),y?(0,u.jsx)(y,{value:T,onChange:R,language:"html",className:"wppf-code-editor"}):(0,u.jsx)(h,{label:(0,s.__)("Frozen HTML","pin-freeze"),value:T,onChange:R,rows:12,className:"wppf-code-editor-fallback"}),(0,u.jsx)("div",{className:"wppf-html-actions",children:(0,u.jsx)(_,{variant:"primary",onClick:()=>{const e=T||"";e!==(o||"")&&(E(""),a({wppf_html:e,wppf_history:j(o,M)}),B((0,s.__)("Cambios aplicados. Revisa el bloque pineado actualizado en el lienzo.","pin-freeze")))},disabled:!I||C,children:(0,s.__)("Aplicar cambios","pin-freeze")})}),!!H&&(0,u.jsx)(m,{status:"success",isDismissible:!1,className:"wppf-block-capture-notice",children:(0,u.jsx)("p",{children:H})}),(0,u.jsxs)("div",{className:"wppf-block-history",children:[(0,u.jsx)("p",{className:"wppf-inspector-help",children:(0,s.__)("Historial del bloque (últimas 5 versiones aplicadas):","pin-freeze")}),M.length>0?(0,u.jsx)("ul",{className:"wppf-block-history-list",children:M.map((e,t)=>(0,u.jsxs)("li",{className:"wppf-block-history-item",children:[(0,u.jsxs)("div",{className:"wppf-block-history-meta",children:[(0,u.jsx)("span",{className:"wppf-block-history-date",children:N(e.capturedAt)}),(0,u.jsx)("code",{className:"wppf-block-history-excerpt",children:k(e.html)||(0,s.__)("(Sin contenido)","pin-freeze")})]}),(0,u.jsx)(_,{variant:"secondary",size:"small",onClick:()=>(e=>{const t=M[e];if(!t)return;if(t.html===(o||""))return L(t.html),void B((0,s.__)("Esta versión ya está aplicada.","pin-freeze"));const n=j(o,M.filter((t,n)=>n!==e));E(""),a({wppf_html:t.html,wppf_history:n}),L(t.html),B((0,s.__)("Versión del historial restaurada y aplicada.","pin-freeze"))})(t),disabled:C,children:(0,s.__)("Restaurar","pin-freeze")})]},`${e.capturedAt||"entry"}-${t}`))}):(0,u.jsx)("p",{className:"wppf-block-history-empty",children:(0,s.__)("Aún no hay historial para este bloque.","pin-freeze")})]})]})]})})},S=function({className:e="",label:t="",actionLabel:n="",onRequestSelect:i,onRequestUnpin:r}){const a=Boolean(r&&n),o=Boolean(r&&!a),l=Boolean(i&&!o),p=Boolean(o||l),c=e=>{p&&(e.preventDefault(),e.stopPropagation(),o&&r?r():l&&i&&i())};return(0,u.jsx)("div",{className:`wppf-pin-overlay ${e}`.trim(),role:p?"button":void 0,tabIndex:p?0:void 0,onClick:p?c:void 0,onKeyDown:p?e=>{p&&("Enter"!==e.key&&" "!==e.key||(e.preventDefault(),c(e)))}:void 0,children:(0,u.jsxs)("div",{className:"wppf-pin-overlay__content",children:[(0,u.jsxs)("span",{className:"wppf-pin-overlay__title-row",children:[(0,u.jsx)("span",{className:"wppf-pin-overlay__icon","aria-hidden":"true",children:(0,u.jsx)("svg",{viewBox:"0 0 24 24",focusable:"false",children:(0,u.jsx)("path",{d:"M16 9V4l1-1V2H7v1l1 1v5l-2 2v1h5v7l1 1 1-1v-7h5v-1l-2-2z"})})}),(0,u.jsx)("span",{className:"wppf-pin-overlay__title",children:t||(0,s.__)("Este contenido está pineado.","pin-freeze")})]}),!a&&(0,u.jsx)("span",{className:"wppf-pin-overlay__subtitle",children:(0,s.__)("Haz clic para despinearlo.","pin-freeze")}),a&&(0,u.jsx)("button",{type:"button",className:"wppf-pin-overlay__button",onClick:e=>{e.preventDefault(),e.stopPropagation(),r&&r()},children:n})]})})},P=window.wp.date,E=window.wp.editPost,T="_wppf_is_post_pinned",L="_wppf_post_html";function H(){const e=(0,n.useSelect)(e=>e("core/editor").getEditedPostAttribute("meta")||{},[]),{editPost:t}=(0,n.useDispatch)("core/editor"),i=Boolean(e[T]),r=e[L]||"",s=n=>{t({meta:{...e,...n}})};return{html:r,isPinned:i,pinCurrentState:()=>{const e=(0,n.select)("core/editor").getEditedPostContent()||"";s({[T]:!0,[L]:e})},setHtml:e=>{s({[L]:e||""})},setPinned:e=>{s({[T]:Boolean(e)})}}}const{Button:B,Notice:D,SelectControl:q,Spinner:M,TabPanel:R,TextareaControl:A,ToggleControl:I}=d,F=d.__experimentalCodeEditor||d.CodeEditor;function O(){return window?.wppfEditorSettings||{}}async function U(e,t){const n=O().ajaxUrl||window?.ajaxurl||"";if(!n)throw new Error((0,s.__)("No se encontró la URL de AJAX para Pin & Freeze.","pin-freeze"));const i=new window.FormData;i.append("action",e),i.append("nonce",O().nonce||""),Object.entries(t||{}).forEach(([e,t])=>{const n=null==t?"":String(t);i.append(e,n)});const r=await window.fetch(n,{method:"POST",credentials:"same-origin",body:i});if(!r.ok)throw new Error((0,s.sprintf)(/* translators: %d: HTTP status code */ /* translators: %d: HTTP status code */
(0,s.__)("Error de red al procesar la petición (%d).","pin-freeze"),r.status));let a=null;try{a=await r.json()}catch{throw new Error((0,s.__)("La respuesta del servidor no es válida. Verifica si el sitio está en mantenimiento o inaccesible.","pin-freeze"))}if(!a?.success)throw new Error(a?.data?.message||(0,s.__)("No se pudo completar la operación de pinning.","pin-freeze"));return a.data||{}}function $(e){const t=e?._embedded?.author?.[0]?.name;return t||(0,s.__)("Autor desconocido","pin-freeze")}const V=function(){const{html:e,isPinned:t,setHtml:r,setPinned:a}=H(),[o,l]=(0,i.useState)("editor"),[p,c]=(0,i.useState)(!1),[d,f]=(0,i.useState)(!1),[_,m]=(0,i.useState)(!1),[w,h]=(0,i.useState)(""),[b,y]=(0,i.useState)(""),g=(0,n.useSelect)(e=>e("core/editor").getCurrentPostId(),[]),v=O().snapshotPostType||"wppf_snapshot",z=(0,i.useMemo)(()=>({per_page:20,parent:g,order:"desc",orderby:"date",context:"edit",_embed:!0}),[g]),x=(0,n.useSelect)(e=>g?(e("core").getEntityRecords("postType",v,z)||[]).filter(e=>Number(e?.parent)===Number(g)).slice(0,5):[],[g,v,z]),j=(0,n.useSelect)(e=>!!g&&e("core/data").isResolving("core","getEntityRecords",["postType",v,z]),[g,v,z]),N=Boolean(O().canUnfilteredHtml),k=O().captureSelector||"#content",C=()=>{y(""),h("")},S=async()=>{if(C(),g){c(!0);try{const e=await U("wppf_fetch_frontend",{post_id:g});r(e.html||""),h((0,s.__)("Contenido capturado desde frontend. Revísalo y guarda el pin.","pin-freeze"))}catch(e){y(e?.message||(0,s.__)("Error al capturar frontend.","pin-freeze"))}finally{c(!1)}}else y((0,s.__)("No se encontró el ID del contenido actual.","pin-freeze"))},T=async()=>{if(C(),g){f(!0);try{let t=e||"";if("editor"===o&&(t=(0,n.select)("core/editor").getEditedPostContent()||"",r(t)),!t.trim())throw new Error((0,s.__)("No hay HTML para pinear.","pin-freeze"));const i=await U("wppf_save_post_pin",{post_id:g,html:t,is_pinned:1});i?.html&&r(i.html),a(!0),h(i?.message||(0,s.__)("Pin guardado correctamente.","pin-freeze"))}catch(e){y(e?.message||(0,s.__)("Error guardando el pin.","pin-freeze"))}finally{f(!1)}}else y((0,s.__)("No se encontró el ID del contenido actual.","pin-freeze"))};return(0,u.jsxs)(E.PluginDocumentSettingPanel,{name:"wppf-post-pinning",title:(0,s.__)("Post Pinning","pin-freeze"),className:"wppf-post-panel",children:[(0,u.jsx)(I,{label:(0,s.__)("Pin complete post HTML","pin-freeze"),help:t?(0,s.__)("El frontend mostrará el HTML estático guardado en meta.","pin-freeze"):(0,s.__)("Permite reemplazar todo el contenido de frontend por HTML estático.","pin-freeze"),checked:t,onChange:a}),t&&(0,u.jsx)(D,{status:"warning",isDismissible:!1,children:(0,s.__)("La edición visual queda bloqueada mientras esta entrada/página esté pineada.","pin-freeze")}),!N&&(0,u.jsx)(D,{status:"info",isDismissible:!1,children:(0,s.__)("Tu rol no tiene unfiltered_html. El HTML se sanitizará automáticamente al guardar y renderizar.","pin-freeze")}),b&&(0,u.jsx)(D,{status:"error",isDismissible:!0,onRemove:()=>y(""),children:b}),w&&(0,u.jsx)(D,{status:"success",isDismissible:!0,onRemove:()=>h(""),children:w}),(0,u.jsx)(R,{className:"wppf-post-tabs",tabs:[{name:"capture",title:(0,s.__)("Capture","pin-freeze")},{name:"history",title:(0,s.__)("Pin History","pin-freeze")}],children:t=>"history"===t.name?j?(0,u.jsx)("div",{className:"wppf-history-loading",children:(0,u.jsx)(M,{})}):x.length?(0,u.jsx)("ul",{className:"wppf-history-list",children:x.map(e=>{return(0,u.jsxs)("li",{className:"wppf-history-item",children:[(0,u.jsxs)("div",{className:"wppf-history-item__meta",children:[(0,u.jsx)("strong",{children:(t=e.date,t?(0,P.dateI18n)("Y-m-d H:i",t):(0,s.__)("Sin fecha","pin-freeze"))}),(0,u.jsx)("span",{children:$(e)})]}),(0,u.jsx)(B,{variant:"secondary",onClick:()=>(async e=>{if(C(),!g)return void y((0,s.__)("No se encontró el ID del contenido actual.","pin-freeze"));const t=function(e){return e?.content?.raw?e.content.raw:e?.content?.rendered?e.content.rendered:""}(e);if(t){m(!0);try{const e=await U("wppf_save_post_pin",{post_id:g,html:t,is_pinned:1,skip_snapshot:1});r(e?.html||t),a(!0),h((0,s.__)("Snapshot restaurado y meta actualizada correctamente.","pin-freeze"))}catch(e){y(e?.message||(0,s.__)("No se pudo restaurar el snapshot.","pin-freeze"))}finally{m(!1)}}else y((0,s.__)("El snapshot seleccionado no contiene HTML utilizable.","pin-freeze"))})(e),disabled:_||d||p,children:(0,s.__)("Restaurar","pin-freeze")})]},e.id);var t})}):(0,u.jsx)("p",{className:"wppf-history-empty",children:(0,s.__)("No hay snapshots todavía para esta entrada.","pin-freeze")}):(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(q,{label:(0,s.__)("Modo de Captura","pin-freeze"),value:o,onChange:l,options:[{label:(0,s.__)("Editor State","pin-freeze"),value:"editor"},{label:(0,s.__)("Live Frontend","pin-freeze"),value:"live"}]}),"live"===o&&(0,u.jsx)("p",{className:"wppf-capture-selector-hint",children:(0,s.sprintf)(/* translators: %s: CSS selector */ /* translators: %s: CSS selector */
(0,s.__)("Selector configurado: %s","pin-freeze"),k)}),(0,u.jsxs)("div",{className:"wppf-post-actions",children:["live"===o&&(0,u.jsx)(B,{variant:"secondary",onClick:S,disabled:p||d,children:p?(0,s.__)("Capturando…","pin-freeze"):(0,s.__)("Fetch & Pin URL","pin-freeze")}),(0,u.jsx)(B,{variant:"primary",onClick:T,disabled:d||p,children:d?(0,s.__)("Guardando…","pin-freeze"):(0,s.__)("Pin HTML (Guardar)","pin-freeze")})]}),F?(0,u.jsx)(F,{value:e,onChange:r,language:"html",className:"wppf-post-code-editor"}):(0,u.jsx)(A,{label:(0,s.__)("Post Frozen HTML","pin-freeze"),value:e,onChange:r,rows:18,className:"wppf-post-code-editor-fallback"})]})})]})},G={wppf_is_pinned:{type:"boolean",default:!1},wppf_html:{type:"string",default:""},wppf_history:{type:"array",default:[]}},J=(0,t.createHigherOrderComponent)(e=>t=>(0,u.jsxs)(i.Fragment,{children:[(0,u.jsx)(e,{...t}),(0,u.jsx)(C,{...t})]}),"withBlockPinControl"),X=(0,t.createHigherOrderComponent)(e=>t=>{const i=Boolean(t?.attributes?.wppf_is_pinned),r="string"==typeof t?.attributes?.wppf_html?t.attributes.wppf_html:"",a=Boolean(r.trim());return i?(0,u.jsxs)("div",{className:"wppf-block-lock-wrapper"+(a?" wppf-block-lock-wrapper--has-preview":""),children:[(0,u.jsx)("div",{className:"wppf-block-lock-wrapper__source",children:(0,u.jsx)(e,{...t})}),a&&(0,u.jsx)("div",{className:"wppf-block-live-preview","aria-hidden":"true",children:(0,u.jsx)("div",{className:"wppf-block-live-preview__markup",dangerouslySetInnerHTML:{__html:r}})}),(0,u.jsx)(S,{label:(0,s.__)("Bloque pineado","pin-freeze"),actionLabel:(0,s.__)("Despinear bloque","pin-freeze"),onRequestSelect:()=>{t?.clientId&&(0,n.dispatch)("core/block-editor").selectBlock(t.clientId)},onRequestUnpin:()=>{const e=window?.wppfEditorSettings?.blockUnpinConfirm||(0,s.__)("Este bloque está pineado. ¿Deseas despinearlo para editar?","pin-freeze");window.confirm(e)&&t.setAttributes({wppf_is_pinned:!1})}})]}):(0,u.jsx)(e,{...t})},"withPinOverlay");function K(){const{isPinned:e,setPinned:t}=H(),[n,r]=(0,i.useState)(null);return(0,i.useEffect)(()=>{r(document.querySelector(".editor-styles-wrapper"))},[]),(0,i.useEffect)(()=>(document.body.classList.toggle("wppf-post-is-pinned",e),()=>document.body.classList.remove("wppf-post-is-pinned")),[e]),e&&n?(0,i.createPortal)((0,u.jsx)(S,{className:"wppf-pin-overlay--post",label:(0,s.__)("Entrada/Página pineada","pin-freeze"),onRequestUnpin:()=>{const e=window?.wppfEditorSettings?.postUnpinConfirm||(0,s.__)("Esta entrada está pineada. ¿Deseas despinearla para editar?","pin-freeze");window.confirm(e)&&t(!1)}}),n):null}(0,r.addFilter)("blocks.registerBlockType","pin-freeze/add-attributes",function(e){return e?.attributes||(e.attributes={}),{...e,attributes:{...e.attributes,...G}}}),(0,r.addFilter)("editor.BlockEdit","pin-freeze/block-pin-control",J),(0,r.addFilter)("editor.BlockListBlock","pin-freeze/block-pin-overlay",X),(0,a.registerPlugin)("pin-freeze-document-plugin",{render:function(){return(0,u.jsxs)(i.Fragment,{children:[(0,u.jsx)(V,{}),(0,u.jsx)(K,{})]})}})})();