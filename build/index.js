(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.compose,n=window.wp.element,i=window.wp.hooks,r=window.wp.i18n,o=window.wp.plugins,s=window.wp.apiFetch;var a=e.n(s);const p=window.wp.blocks,l=window.wp.blockEditor,d=window.wp.components,c=window.wp.data,u=window.wp.url,f=window.ReactJSXRuntime,{Notice:_,PanelBody:w,TextareaControl:m,ToggleControl:h}=d,g=d.__experimentalCodeEditor||d.CodeEditor,b=/^\s*<!--\s*wp:[\s\S]*-->\s*$/;function y(e){return!e||"string"!=typeof e||b.test(e)}function z(e){return"string"!=typeof e?"":e.trim()}const x=function({attributes:e,clientId:t,isSelected:i,setAttributes:o}){const{wppf_html:s="",wppf_is_pinned:d=!1}=e||{},[b,x]=(0,n.useState)(!1),[j,v]=(0,n.useState)(""),{block:P,postId:C}=(0,c.useSelect)(e=>({block:e("core/block-editor").getBlock(t),postId:e("core/editor").getCurrentPostId()}),[t]);if(!i)return null;const N=e=>{v(""),o({wppf_html:e||""})};let k=(0,r.__)("Congela la salida del bloque para reemplazar su render dinámico.","pin-freeze");return d&&(k=(0,r.__)("Este bloque está pineado y usa HTML estático.","pin-freeze")),b&&(k=(0,r.__)("Capturando HTML renderizado del bloque…","pin-freeze")),(0,f.jsx)(l.InspectorControls,{children:(0,f.jsxs)(w,{title:(0,r.__)("Pin & Freeze","pin-freeze"),initialOpen:!0,children:[(0,f.jsx)(h,{label:(0,r.__)("Pin HTML","pin-freeze"),help:k,checked:d,onChange:async e=>{if(!e)return v(""),void o({wppf_is_pinned:!1});if(s&&!y(s))return v(""),void o({wppf_is_pinned:!0});x(!0),v("");try{const e=await(async()=>{if(!P)return"";const e=(0,p.getBlockType)(P.name),t=z((0,p.getBlockContent)(P));if(!e||"function"!=typeof e.save||y(t))try{const e={context:"edit"};C&&(e.post_id=Number(C));const t=(0,u.addQueryArgs)(`/wp/v2/block-renderer/${encodeURIComponent(P.name)}`,e),n=await a()({path:t,method:"POST",data:{attributes:P.attributes||{}}}),i=z(n?.rendered||"");if(i&&!y(i))return i}catch{}return t&&!y(t)?t:""})();if(e)return void o({wppf_is_pinned:!0,wppf_html:e});o({wppf_is_pinned:!1}),v((0,r.__)("No se pudo capturar HTML renderizado para este bloque. Intenta refrescar o guardar y reintentar.","pin-freeze"))}finally{x(!1)}},disabled:b}),!!j&&(0,f.jsx)(_,{status:"warning",isDismissible:!1,className:"wppf-block-capture-notice",children:(0,f.jsx)("p",{children:j})}),d&&(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)("p",{className:"wppf-inspector-help",children:(0,r.__)("HTML estático del bloque pineado:","pin-freeze")}),g?(0,f.jsx)(g,{value:s,onChange:N,language:"html",className:"wppf-code-editor"}):(0,f.jsx)(m,{label:(0,r.__)("Frozen HTML","pin-freeze"),value:s,onChange:N,rows:12,className:"wppf-code-editor-fallback"})]})]})})},j=function({className:e="",label:t="",onRequestUnpin:n}){const i=e=>{e.preventDefault(),e.stopPropagation(),n&&n()};return(0,f.jsxs)("div",{className:`wppf-pin-overlay ${e}`.trim(),role:"button",tabIndex:0,onClick:i,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),i(e))},children:[(0,f.jsx)("span",{className:"dashicons dashicons-lock","aria-hidden":"true"}),(0,f.jsx)("span",{className:"wppf-pin-overlay__title",children:t||(0,r.__)("Este contenido está pineado.","pin-freeze")}),(0,f.jsx)("span",{className:"wppf-pin-overlay__subtitle",children:(0,r.__)("Haz clic para despinearlo.","pin-freeze")})]})},v=window.wp.date,P=window.wp.editPost,C="_wppf_is_post_pinned",N="_wppf_post_html";function k(){const e=(0,c.useSelect)(e=>e("core/editor").getEditedPostAttribute("meta")||{},[]),{editPost:t}=(0,c.useDispatch)("core/editor"),n=Boolean(e[C]),i=e[N]||"",r=n=>{t({meta:{...e,...n}})};return{html:i,isPinned:n,pinCurrentState:()=>{const e=(0,c.select)("core/editor").getEditedPostContent()||"";r({[C]:!0,[N]:e})},setHtml:e=>{r({[N]:e||""})},setPinned:e=>{r({[C]:Boolean(e)})}}}const{Button:E,Notice:S,SelectControl:T,Spinner:H,TabPanel:L,TextareaControl:M,ToggleControl:D}=d,B=d.__experimentalCodeEditor||d.CodeEditor;function F(){return window?.wppfEditorSettings||{}}async function R(e,t){const n=F().ajaxUrl||window?.ajaxurl||"";if(!n)throw new Error((0,r.__)("No se encontró la URL de AJAX para Pin & Freeze.","pin-freeze"));const i=new window.FormData;i.append("action",e),i.append("nonce",F().nonce||""),Object.entries(t||{}).forEach(([e,t])=>{const n=null==t?"":String(t);i.append(e,n)});const o=await window.fetch(n,{method:"POST",credentials:"same-origin",body:i});if(!o.ok)throw new Error((0,r.sprintf)(/* translators: %d: HTTP status code */ /* translators: %d: HTTP status code */
(0,r.__)("Error de red al procesar la petición (%d).","pin-freeze"),o.status));let s=null;try{s=await o.json()}catch{throw new Error((0,r.__)("La respuesta del servidor no es válida. Verifica si el sitio está en mantenimiento o inaccesible.","pin-freeze"))}if(!s?.success)throw new Error(s?.data?.message||(0,r.__)("No se pudo completar la operación de pinning.","pin-freeze"));return s.data||{}}function q(e){const t=e?._embedded?.author?.[0]?.name;return t||(0,r.__)("Autor desconocido","pin-freeze")}const I=function(){const{html:e,isPinned:t,setHtml:i,setPinned:o}=k(),[s,a]=(0,n.useState)("editor"),[p,l]=(0,n.useState)(!1),[d,u]=(0,n.useState)(!1),[_,w]=(0,n.useState)(!1),[m,h]=(0,n.useState)(""),[g,b]=(0,n.useState)(""),y=(0,c.useSelect)(e=>e("core/editor").getCurrentPostId(),[]),z=F().snapshotPostType||"wppf_snapshot",x=(0,n.useMemo)(()=>({per_page:20,parent:y,order:"desc",orderby:"date",context:"edit",_embed:!0}),[y]),j=(0,c.useSelect)(e=>y?(e("core").getEntityRecords("postType",z,x)||[]).filter(e=>Number(e?.parent)===Number(y)).slice(0,5):[],[y,z,x]),C=(0,c.useSelect)(e=>!!y&&e("core/data").isResolving("core","getEntityRecords",["postType",z,x]),[y,z,x]),N=Boolean(F().canUnfilteredHtml),I=F().captureSelector||"#content",O=()=>{b(""),h("")},U=async()=>{if(O(),y){l(!0);try{const e=await R("wppf_fetch_frontend",{post_id:y});i(e.html||""),h((0,r.__)("Contenido capturado desde frontend. Revísalo y guarda el pin.","pin-freeze"))}catch(e){b(e?.message||(0,r.__)("Error al capturar frontend.","pin-freeze"))}finally{l(!1)}}else b((0,r.__)("No se encontró el ID del contenido actual.","pin-freeze"))},A=async()=>{if(O(),y){u(!0);try{let t=e||"";if("editor"===s&&(t=(0,c.select)("core/editor").getEditedPostContent()||"",i(t)),!t.trim())throw new Error((0,r.__)("No hay HTML para pinear.","pin-freeze"));const n=await R("wppf_save_post_pin",{post_id:y,html:t,is_pinned:1});n?.html&&i(n.html),o(!0),h(n?.message||(0,r.__)("Pin guardado correctamente.","pin-freeze"))}catch(e){b(e?.message||(0,r.__)("Error guardando el pin.","pin-freeze"))}finally{u(!1)}}else b((0,r.__)("No se encontró el ID del contenido actual.","pin-freeze"))};return(0,f.jsxs)(P.PluginDocumentSettingPanel,{name:"wppf-post-pinning",title:(0,r.__)("Post Pinning","pin-freeze"),className:"wppf-post-panel",children:[(0,f.jsx)(D,{label:(0,r.__)("Pin complete post HTML","pin-freeze"),help:t?(0,r.__)("El frontend mostrará el HTML estático guardado en meta.","pin-freeze"):(0,r.__)("Permite reemplazar todo el contenido de frontend por HTML estático.","pin-freeze"),checked:t,onChange:o}),t&&(0,f.jsx)(S,{status:"warning",isDismissible:!1,children:(0,r.__)("La edición visual queda bloqueada mientras esta entrada/página esté pineada.","pin-freeze")}),!N&&(0,f.jsx)(S,{status:"info",isDismissible:!1,children:(0,r.__)("Tu rol no tiene unfiltered_html. El HTML se sanitizará automáticamente al guardar y renderizar.","pin-freeze")}),g&&(0,f.jsx)(S,{status:"error",isDismissible:!0,onRemove:()=>b(""),children:g}),m&&(0,f.jsx)(S,{status:"success",isDismissible:!0,onRemove:()=>h(""),children:m}),(0,f.jsx)(L,{className:"wppf-post-tabs",tabs:[{name:"capture",title:(0,r.__)("Capture","pin-freeze")},{name:"history",title:(0,r.__)("Pin History","pin-freeze")}],children:t=>"history"===t.name?C?(0,f.jsx)("div",{className:"wppf-history-loading",children:(0,f.jsx)(H,{})}):j.length?(0,f.jsx)("ul",{className:"wppf-history-list",children:j.map(e=>{return(0,f.jsxs)("li",{className:"wppf-history-item",children:[(0,f.jsxs)("div",{className:"wppf-history-item__meta",children:[(0,f.jsx)("strong",{children:(t=e.date,t?(0,v.dateI18n)("Y-m-d H:i",t):(0,r.__)("Sin fecha","pin-freeze"))}),(0,f.jsx)("span",{children:q(e)})]}),(0,f.jsx)(E,{variant:"secondary",onClick:()=>(async e=>{if(O(),!y)return void b((0,r.__)("No se encontró el ID del contenido actual.","pin-freeze"));const t=function(e){return e?.content?.raw?e.content.raw:e?.content?.rendered?e.content.rendered:""}(e);if(t){w(!0);try{const e=await R("wppf_save_post_pin",{post_id:y,html:t,is_pinned:1,skip_snapshot:1});i(e?.html||t),o(!0),h((0,r.__)("Snapshot restaurado y meta actualizada correctamente.","pin-freeze"))}catch(e){b(e?.message||(0,r.__)("No se pudo restaurar el snapshot.","pin-freeze"))}finally{w(!1)}}else b((0,r.__)("El snapshot seleccionado no contiene HTML utilizable.","pin-freeze"))})(e),disabled:_||d||p,children:(0,r.__)("Restaurar","pin-freeze")})]},e.id);var t})}):(0,f.jsx)("p",{className:"wppf-history-empty",children:(0,r.__)("No hay snapshots todavía para esta entrada.","pin-freeze")}):(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(T,{label:(0,r.__)("Modo de Captura","pin-freeze"),value:s,onChange:a,options:[{label:(0,r.__)("Editor State","pin-freeze"),value:"editor"},{label:(0,r.__)("Live Frontend","pin-freeze"),value:"live"}]}),"live"===s&&(0,f.jsx)("p",{className:"wppf-capture-selector-hint",children:(0,r.sprintf)(/* translators: %s: CSS selector */ /* translators: %s: CSS selector */
(0,r.__)("Selector configurado: %s","pin-freeze"),I)}),(0,f.jsxs)("div",{className:"wppf-post-actions",children:["live"===s&&(0,f.jsx)(E,{variant:"secondary",onClick:U,disabled:p||d,children:p?(0,r.__)("Capturando…","pin-freeze"):(0,r.__)("Fetch & Pin URL","pin-freeze")}),(0,f.jsx)(E,{variant:"primary",onClick:A,disabled:d||p,children:d?(0,r.__)("Guardando…","pin-freeze"):(0,r.__)("Pin HTML (Guardar)","pin-freeze")})]}),B?(0,f.jsx)(B,{value:e,onChange:i,language:"html",className:"wppf-post-code-editor"}):(0,f.jsx)(M,{label:(0,r.__)("Post Frozen HTML","pin-freeze"),value:e,onChange:i,rows:18,className:"wppf-post-code-editor-fallback"})]})})]})},O={wppf_is_pinned:{type:"boolean",default:!1},wppf_html:{type:"string",default:""}},U=(0,t.createHigherOrderComponent)(e=>t=>(0,f.jsxs)(n.Fragment,{children:[(0,f.jsx)(e,{...t}),(0,f.jsx)(x,{...t})]}),"withBlockPinControl"),A=(0,t.createHigherOrderComponent)(e=>t=>Boolean(t?.attributes?.wppf_is_pinned)?(0,f.jsxs)("div",{className:"wppf-block-lock-wrapper",children:[(0,f.jsx)(e,{...t}),(0,f.jsx)(j,{label:(0,r.__)("Bloque pineado","pin-freeze"),onRequestUnpin:()=>{const e=window?.wppfEditorSettings?.blockUnpinConfirm||(0,r.__)("Este bloque está pineado. ¿Deseas despinearlo para editar?","pin-freeze");window.confirm(e)&&t.setAttributes({wppf_is_pinned:!1})}})]}):(0,f.jsx)(e,{...t}),"withPinOverlay");function $(){const{isPinned:e,setPinned:t}=k(),[i,o]=(0,n.useState)(null);return(0,n.useEffect)(()=>{o(document.querySelector(".editor-styles-wrapper"))},[]),(0,n.useEffect)(()=>(document.body.classList.toggle("wppf-post-is-pinned",e),()=>document.body.classList.remove("wppf-post-is-pinned")),[e]),e&&i?(0,n.createPortal)((0,f.jsx)(j,{className:"wppf-pin-overlay--post",label:(0,r.__)("Entrada/Página pineada","pin-freeze"),onRequestUnpin:()=>{const e=window?.wppfEditorSettings?.postUnpinConfirm||(0,r.__)("Esta entrada está pineada. ¿Deseas despinearla para editar?","pin-freeze");window.confirm(e)&&t(!1)}}),i):null}(0,i.addFilter)("blocks.registerBlockType","pin-freeze/add-attributes",function(e){return e?.attributes||(e.attributes={}),{...e,attributes:{...e.attributes,...O}}}),(0,i.addFilter)("editor.BlockEdit","pin-freeze/block-pin-control",U),(0,i.addFilter)("editor.BlockListBlock","pin-freeze/block-pin-overlay",A),(0,o.registerPlugin)("pin-freeze-document-plugin",{render:function(){return(0,f.jsxs)(n.Fragment,{children:[(0,f.jsx)(I,{}),(0,f.jsx)($,{})]})}})})();