(()=>{"use strict";const e=window.wp.compose,n=window.wp.element,t=window.wp.hooks,i=window.wp.i18n,r=window.wp.plugins,s=window.wp.blocks,o=window.wp.blockEditor,a=window.wp.components,p=window.wp.data,l=window.ReactJSXRuntime,{PanelBody:d,TextareaControl:c,ToggleControl:w}=a,_=a.__experimentalCodeEditor||a.CodeEditor,f=function({attributes:e,clientId:n,isSelected:t,setAttributes:r}){const{wppf_html:a="",wppf_is_pinned:f=!1}=e||{},u=(0,p.useSelect)(e=>e("core/block-editor").getBlock(n),[n]);if(!t)return null;const m=e=>{r({wppf_html:e||""})};return(0,l.jsx)(o.InspectorControls,{children:(0,l.jsxs)(d,{title:(0,i.__)("WP Pin & Freeze","wp-pin-freeze"),initialOpen:!0,children:[(0,l.jsx)(w,{label:(0,i.__)("Pin HTML","wp-pin-freeze"),help:f?(0,i.__)("Este bloque está pineado y usa HTML estático.","wp-pin-freeze"):(0,i.__)("Congela la salida del bloque para reemplazar su render dinámico.","wp-pin-freeze"),checked:f,onChange:e=>{r(!e||a?{wppf_is_pinned:Boolean(e)}:{wppf_is_pinned:!0,wppf_html:u?(0,s.serialize)([u]):""})}}),f&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("p",{className:"wppf-inspector-help",children:(0,i.__)("HTML estático del bloque pineado:","wp-pin-freeze")}),_?(0,l.jsx)(_,{value:a,onChange:m,language:"html",className:"wppf-code-editor"}):(0,l.jsx)(c,{label:(0,i.__)("Frozen HTML","wp-pin-freeze"),value:a,onChange:m,rows:12,className:"wppf-code-editor-fallback"})]})]})})},u=function({className:e="",label:n="",onRequestUnpin:t}){const r=e=>{e.preventDefault(),e.stopPropagation(),t&&t()};return(0,l.jsxs)("div",{className:`wppf-pin-overlay ${e}`.trim(),role:"button",tabIndex:0,onClick:r,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),r(e))},children:[(0,l.jsx)("span",{className:"dashicons dashicons-lock","aria-hidden":"true"}),(0,l.jsx)("span",{className:"wppf-pin-overlay__title",children:n||(0,i.__)("Este contenido está pineado.","wp-pin-freeze")}),(0,l.jsx)("span",{className:"wppf-pin-overlay__subtitle",children:(0,i.__)("Haz clic para despinearlo.","wp-pin-freeze")})]})},m=window.wp.date,h=window.wp.editPost,g="_wppf_is_post_pinned",z="_wppf_post_html";function b(){const e=(0,p.useSelect)(e=>e("core/editor").getEditedPostAttribute("meta")||{},[]),{editPost:n}=(0,p.useDispatch)("core/editor"),t=Boolean(e[g]),i=e[z]||"",r=t=>{n({meta:{...e,...t}})};return{html:i,isPinned:t,pinCurrentState:()=>{const e=(0,p.select)("core/editor").getEditedPostContent()||"";r({[g]:!0,[z]:e})},setHtml:e=>{r({[z]:e||""})},setPinned:e=>{r({[g]:Boolean(e)})}}}const{Button:x,Notice:y,SelectControl:j,Spinner:v,TabPanel:P,TextareaControl:C,ToggleControl:E}=a,N=a.__experimentalCodeEditor||a.CodeEditor;function k(){return window?.wppfEditorSettings||{}}async function S(e,n){const t=k().ajaxUrl||window?.ajaxurl||"";if(!t)throw new Error((0,i.__)("No se encontró la URL de AJAX para WP Pin & Freeze.","wp-pin-freeze"));const r=new window.FormData;r.append("action",e),r.append("nonce",k().nonce||""),Object.entries(n||{}).forEach(([e,n])=>{const t=null==n?"":String(n);r.append(e,t)});const s=await window.fetch(t,{method:"POST",credentials:"same-origin",body:r});if(!s.ok)throw new Error((0,i.sprintf)(/* translators: %d: HTTP status code */ /* translators: %d: HTTP status code */
(0,i.__)("Error de red al procesar la petición (%d).","wp-pin-freeze"),s.status));let o=null;try{o=await s.json()}catch{throw new Error((0,i.__)("La respuesta del servidor no es válida. Verifica si el sitio está en mantenimiento o inaccesible.","wp-pin-freeze"))}if(!o?.success)throw new Error(o?.data?.message||(0,i.__)("No se pudo completar la operación de pinning.","wp-pin-freeze"));return o.data||{}}function T(e){const n=e?._embedded?.author?.[0]?.name;return n||(0,i.__)("Autor desconocido","wp-pin-freeze")}const H=function(){const{html:e,isPinned:t,setHtml:r,setPinned:s}=b(),[o,a]=(0,n.useState)("editor"),[d,c]=(0,n.useState)(!1),[w,_]=(0,n.useState)(!1),[f,u]=(0,n.useState)(!1),[g,z]=(0,n.useState)(""),[H,L]=(0,n.useState)(""),D=(0,p.useSelect)(e=>e("core/editor").getCurrentPostId(),[]),B=k().snapshotPostType||"wppf_snapshot",F=(0,n.useMemo)(()=>({per_page:20,parent:D,order:"desc",orderby:"date",context:"edit",_embed:!0}),[D]),M=(0,p.useSelect)(e=>D?(e("core").getEntityRecords("postType",B,F)||[]).filter(e=>Number(e?.parent)===Number(D)).slice(0,5):[],[D,B,F]),R=(0,p.useSelect)(e=>!!D&&e("core/data").isResolving("core","getEntityRecords",["postType",B,F]),[D,B,F]),q=Boolean(k().canUnfilteredHtml),U=k().captureSelector||"#content",I=()=>{L(""),z("")},A=async()=>{if(I(),D){c(!0);try{const e=await S("wppf_fetch_frontend",{post_id:D});r(e.html||""),z((0,i.__)("Contenido capturado desde frontend. Revísalo y guarda el pin.","wp-pin-freeze"))}catch(e){L(e?.message||(0,i.__)("Error al capturar frontend.","wp-pin-freeze"))}finally{c(!1)}}else L((0,i.__)("No se encontró el ID del contenido actual.","wp-pin-freeze"))},O=async()=>{if(I(),D){_(!0);try{let n=e||"";if("editor"===o&&(n=(0,p.select)("core/editor").getEditedPostContent()||"",r(n)),!n.trim())throw new Error((0,i.__)("No hay HTML para pinear.","wp-pin-freeze"));const t=await S("wppf_save_post_pin",{post_id:D,html:n,is_pinned:1});t?.html&&r(t.html),s(!0),z(t?.message||(0,i.__)("Pin guardado correctamente.","wp-pin-freeze"))}catch(e){L(e?.message||(0,i.__)("Error guardando el pin.","wp-pin-freeze"))}finally{_(!1)}}else L((0,i.__)("No se encontró el ID del contenido actual.","wp-pin-freeze"))};return(0,l.jsxs)(h.PluginDocumentSettingPanel,{name:"wppf-post-pinning",title:(0,i.__)("Post Pinning","wp-pin-freeze"),className:"wppf-post-panel",children:[(0,l.jsx)(E,{label:(0,i.__)("Pin complete post HTML","wp-pin-freeze"),help:t?(0,i.__)("El frontend mostrará el HTML estático guardado en meta.","wp-pin-freeze"):(0,i.__)("Permite reemplazar todo el contenido de frontend por HTML estático.","wp-pin-freeze"),checked:t,onChange:s}),t&&(0,l.jsx)(y,{status:"warning",isDismissible:!1,children:(0,i.__)("La edición visual queda bloqueada mientras esta entrada/página esté pineada.","wp-pin-freeze")}),!q&&(0,l.jsx)(y,{status:"info",isDismissible:!1,children:(0,i.__)("Tu rol no tiene unfiltered_html. El HTML se sanitizará automáticamente al guardar y renderizar.","wp-pin-freeze")}),H&&(0,l.jsx)(y,{status:"error",isDismissible:!0,onRemove:()=>L(""),children:H}),g&&(0,l.jsx)(y,{status:"success",isDismissible:!0,onRemove:()=>z(""),children:g}),(0,l.jsx)(P,{className:"wppf-post-tabs",tabs:[{name:"capture",title:(0,i.__)("Capture","wp-pin-freeze")},{name:"history",title:(0,i.__)("Pin History","wp-pin-freeze")}],children:n=>"history"===n.name?R?(0,l.jsx)("div",{className:"wppf-history-loading",children:(0,l.jsx)(v,{})}):M.length?(0,l.jsx)("ul",{className:"wppf-history-list",children:M.map(e=>{return(0,l.jsxs)("li",{className:"wppf-history-item",children:[(0,l.jsxs)("div",{className:"wppf-history-item__meta",children:[(0,l.jsx)("strong",{children:(n=e.date,n?(0,m.dateI18n)("Y-m-d H:i",n):(0,i.__)("Sin fecha","wp-pin-freeze"))}),(0,l.jsx)("span",{children:T(e)})]}),(0,l.jsx)(x,{variant:"secondary",onClick:()=>(async e=>{if(I(),!D)return void L((0,i.__)("No se encontró el ID del contenido actual.","wp-pin-freeze"));const n=function(e){return e?.content?.raw?e.content.raw:e?.content?.rendered?e.content.rendered:""}(e);if(n){u(!0);try{const e=await S("wppf_save_post_pin",{post_id:D,html:n,is_pinned:1,skip_snapshot:1});r(e?.html||n),s(!0),z((0,i.__)("Snapshot restaurado y meta actualizada correctamente.","wp-pin-freeze"))}catch(e){L(e?.message||(0,i.__)("No se pudo restaurar el snapshot.","wp-pin-freeze"))}finally{u(!1)}}else L((0,i.__)("El snapshot seleccionado no contiene HTML utilizable.","wp-pin-freeze"))})(e),disabled:f||w||d,children:(0,i.__)("Restaurar","wp-pin-freeze")})]},e.id);var n})}):(0,l.jsx)("p",{className:"wppf-history-empty",children:(0,i.__)("No hay snapshots todavía para esta entrada.","wp-pin-freeze")}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(j,{label:(0,i.__)("Modo de Captura","wp-pin-freeze"),value:o,onChange:a,options:[{label:(0,i.__)("Editor State","wp-pin-freeze"),value:"editor"},{label:(0,i.__)("Live Frontend","wp-pin-freeze"),value:"live"}]}),"live"===o&&(0,l.jsx)("p",{className:"wppf-capture-selector-hint",children:(0,i.sprintf)(/* translators: %s: CSS selector */ /* translators: %s: CSS selector */
(0,i.__)("Selector configurado: %s","wp-pin-freeze"),U)}),(0,l.jsxs)("div",{className:"wppf-post-actions",children:["live"===o&&(0,l.jsx)(x,{variant:"secondary",onClick:A,disabled:d||w,children:d?(0,i.__)("Capturando…","wp-pin-freeze"):(0,i.__)("Fetch & Pin URL","wp-pin-freeze")}),(0,l.jsx)(x,{variant:"primary",onClick:O,disabled:w||d,children:w?(0,i.__)("Guardando…","wp-pin-freeze"):(0,i.__)("Pin HTML (Guardar)","wp-pin-freeze")})]}),N?(0,l.jsx)(N,{value:e,onChange:r,language:"html",className:"wppf-post-code-editor"}):(0,l.jsx)(C,{label:(0,i.__)("Post Frozen HTML","wp-pin-freeze"),value:e,onChange:r,rows:18,className:"wppf-post-code-editor-fallback"})]})})]})},L={wppf_is_pinned:{type:"boolean",default:!1},wppf_html:{type:"string",default:""}},D=(0,e.createHigherOrderComponent)(e=>t=>(0,l.jsxs)(n.Fragment,{children:[(0,l.jsx)(e,{...t}),(0,l.jsx)(f,{...t})]}),"withBlockPinControl"),B=(0,e.createHigherOrderComponent)(e=>n=>Boolean(n?.attributes?.wppf_is_pinned)?(0,l.jsxs)("div",{className:"wppf-block-lock-wrapper",children:[(0,l.jsx)(e,{...n}),(0,l.jsx)(u,{label:(0,i.__)("Bloque pineado","wp-pin-freeze"),onRequestUnpin:()=>{const e=window?.wppfEditorSettings?.blockUnpinConfirm||(0,i.__)("Este bloque está pineado. ¿Deseas despinearlo para editar?","wp-pin-freeze");window.confirm(e)&&n.setAttributes({wppf_is_pinned:!1})}})]}):(0,l.jsx)(e,{...n}),"withPinOverlay");function F(){const{isPinned:e,setPinned:t}=b(),[r,s]=(0,n.useState)(null);return(0,n.useEffect)(()=>{s(document.querySelector(".editor-styles-wrapper"))},[]),(0,n.useEffect)(()=>(document.body.classList.toggle("wppf-post-is-pinned",e),()=>document.body.classList.remove("wppf-post-is-pinned")),[e]),e&&r?(0,n.createPortal)((0,l.jsx)(u,{className:"wppf-pin-overlay--post",label:(0,i.__)("Entrada/Página pineada","wp-pin-freeze"),onRequestUnpin:()=>{const e=window?.wppfEditorSettings?.postUnpinConfirm||(0,i.__)("Esta entrada está pineada. ¿Deseas despinearla para editar?","wp-pin-freeze");window.confirm(e)&&t(!1)}}),r):null}(0,t.addFilter)("blocks.registerBlockType","wp-pin-freeze/add-attributes",function(e){return e?.attributes||(e.attributes={}),{...e,attributes:{...e.attributes,...L}}}),(0,t.addFilter)("editor.BlockEdit","wp-pin-freeze/block-pin-control",D),(0,t.addFilter)("editor.BlockListBlock","wp-pin-freeze/block-pin-overlay",B),(0,r.registerPlugin)("wp-pin-freeze-document-plugin",{render:function(){return(0,l.jsxs)(n.Fragment,{children:[(0,l.jsx)(H,{}),(0,l.jsx)(F,{})]})}})})();